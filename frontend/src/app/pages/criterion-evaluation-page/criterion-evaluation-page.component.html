<!-- Loading State -->
<div *ngIf="isLoading && (!professor || !criterio)" class="loading-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center">
        <mat-progress-spinner diameter="50"></mat-progress-spinner>
        <p class="mt-3 text-muted">Carregando avaliações...</p>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div *ngIf="!isLoading || (professor && criterio)" class="criterion-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="header-navigation">
            <button class="back-btn" routerLink="/professores/{{professorId}}">
              <i class="bi bi-arrow-left me-2"></i>
              <span>{{ professor?.nomeCompleto || 'Professor' }}</span>
            </button>
          </div>
          <div class="header-content">
            <h1 class="page-title">{{ criterio?.nome }}</h1>
            <p class="page-subtitle">Avaliações e comentários detalhados</p>
            <div class="professor-info">
              <i class="bi bi-person-circle me-2"></i>
              <span>{{ professor?.nomeCompleto }}</span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-summary">
            <div class="stat-item">
              <div class="stat-number">{{ evaluations.length }}</div>
              <div class="stat-label">Avaliações</div>
            </div>
            <div class="stat-item" *ngIf="evaluations.length > 0">
              <div class="stat-number">{{ getAverageRating() | number:'1.1-1' }}</div>
              <div class="stat-label">Média</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="container">
      <div class="filters-card">
        <div class="filters-header">
          <h3 class="filters-title">
            <i class="bi bi-funnel me-2"></i>
            Filtros e Ordenação
          </h3>
        </div>
        <div class="filters-content">
          <div class="row g-3">
            <div class="col-md-4">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Período</mat-label>
                <mat-select [(ngModel)]="currentPeriodo" (ngModelChange)="onPeriodoChange($event)">
                  <mat-option [value]="null">
                    <i class="bi bi-calendar-range me-2"></i>
                    Todos os Períodos
                  </mat-option>
                  <mat-option *ngFor="let periodo of periodos" [value]="periodo">
                    {{ periodo }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-4">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Ordenação</mat-label>
                <mat-select [(ngModel)]="currentSort" (ngModelChange)="onSortChange($event)">
                  <mat-option [value]="null">
                    <i class="bi bi-clock me-2"></i>
                    Mais Recentes
                  </mat-option>
                  <mat-option value="top">
                    <i class="bi bi-arrow-up me-2"></i>
                    Melhores Avaliados
                  </mat-option>
                  <mat-option value="worst">
                    <i class="bi bi-arrow-down me-2"></i>
                    Piores Avaliados
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-4">
              <div class="filter-actions">
                <button class="btn btn-outline-primary" (click)="resetFilters()">
                  <i class="bi bi-arrow-clockwise me-2"></i>
                  Limpar Filtros
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State for Data -->
  <div *ngIf="isLoading && (professor && criterio)" class="loading-data">
    <div class="container">
      <div class="text-center py-5">
        <mat-progress-spinner diameter="40"></mat-progress-spinner>
        <p class="mt-3 text-muted">Aplicando filtros...</p>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && evaluations.length === 0" class="empty-state">
    <div class="container">
      <div class="empty-card">
        <div class="empty-icon">
          <i class="bi bi-chat-square-dots"></i>
        </div>
        <h3>Nenhuma avaliação encontrada</h3>
        <p *ngIf="!currentPeriodo && !currentSort">
          Este critério ainda não foi avaliado para este professor.
        </p>
        <p *ngIf="currentPeriodo || currentSort">
          Nenhuma avaliação encontrada com os filtros aplicados.
        </p>
        <div class="empty-actions">
          <button class="btn btn-primary" routerLink="/avaliar/professor/{{professorId}}/cadeira/1">
            <i class="bi bi-plus-circle me-2"></i>
            Fazer Primeira Avaliação
          </button>
          <button class="btn btn-outline-secondary" (click)="resetFilters()" *ngIf="currentPeriodo || currentSort">
            <i class="bi bi-funnel me-2"></i>
            Limpar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Evaluations List -->
  <div *ngIf="!isLoading && evaluations.length > 0" class="evaluations-section">
    <div class="container">
      <div class="evaluations-list">
        <div class="evaluation-card" *ngFor="let avaliacao of evaluations; trackBy: trackByEvaluationId">
          <div class="evaluation-header">
            <div class="evaluation-meta">
              <div class="evaluation-id">
                <i class="bi bi-hash me-1"></i>
                Avaliação {{ avaliacao.id }}
              </div>
              <div class="evaluation-date">
                <i class="bi bi-calendar me-1"></i>
                {{ avaliacao.data | date:'dd/MM/yyyy HH:mm' }}
              </div>
              <div class="evaluation-period">
                <i class="bi bi-bookmark me-1"></i>
                {{ avaliacao.periodo }}
              </div>
            </div>
            <div class="evaluation-rating">
              <div class="rating-value">{{ getCriterionRating(avaliacao) }}/5</div>
              <div class="rating-stars">
                <i class="bi bi-star-fill" *ngFor="let star of getStarsArray(getCriterionRating(avaliacao))"></i>
                <i class="bi bi-star" *ngFor="let star of getEmptyStarsArray(getCriterionRating(avaliacao))"></i>
              </div>
            </div>
          </div>

          <div class="evaluation-content">
            <!-- Comments Section -->
            <div *ngIf="avaliacao.comentarios && avaliacao.comentarios.length > 0" class="comments-section">
              <div class="comments-header">
                <h4 class="comments-title">
                  <i class="bi bi-chat-dots me-2"></i>
                  Comentários sobre "{{ criterio?.nome }}"
                </h4>
                <div class="comments-count">{{ avaliacao.comentarios.length }} comentário(s)</div>
              </div>
              
              <div class="comments-list">
                <div class="comment-item" *ngFor="let comentario of avaliacao.comentarios; trackBy: trackByCommentId">
                  <div class="comment-content">
                    <p class="comment-text">{{ comentario.texto }}</p>
                    <div class="comment-footer">
                      <div class="comment-metrics">
                        <div class="score-badge" 
                             [ngClass]="{
                               'score-positive': comentario.score > 0,
                               'score-negative': comentario.score < 0,
                               'score-neutral': comentario.score === 0
                             }">
                          <i class="bi" 
                             [ngClass]="{
                               'bi-arrow-up': comentario.score > 0,
                               'bi-arrow-down': comentario.score < 0,
                               'bi-dash': comentario.score === 0
                             }"></i>
                          <span>{{ comentario.score }}</span>
                        </div>
                        <div class="comment-date">
                          <i class="bi bi-clock me-1"></i>
                          {{ comentario.createdAt | date:'dd/MM/yyyy HH:mm' }}
                        </div>
                      </div>
                      
                      <div class="comment-actions">
                        <button class="action-btn upvote-btn" 
                                [ngClass]="{'active': comentario.userVote === 'up'}"
                                (click)="voteComment(comentario, 'up')"
                                title="Útil">
                          <i class="bi bi-hand-thumbs-up"></i>
                          <span>{{ comentario.upvotes || 0 }}</span>
                        </button>
                        <button class="action-btn downvote-btn" 
                                [ngClass]="{'active': comentario.userVote === 'down'}"
                                (click)="voteComment(comentario, 'down')"
                                title="Não útil">
                          <i class="bi bi-hand-thumbs-down"></i>
                          <span>{{ comentario.downvotes || 0 }}</span>
                        </button>
                        <button class="action-btn report-btn" 
                                (click)="reportComment(comentario)"
                                title="Reportar comentário">
                          <i class="bi bi-flag"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Comments -->
            <div *ngIf="!avaliacao.comentarios || avaliacao.comentarios.length === 0" class="no-comments">
              <div class="no-comments-content">
                <i class="bi bi-chat-square-dots me-2"></i>
                <span>Nenhum comentário específico para "{{ criterio?.nome }}" nesta avaliação</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination-section" *ngIf="totalElements > pageSize">
        <mat-paginator 
          [length]="totalElements"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 20, 50]"
          (page)="pageChanged($event)"
          aria-label="Selecionar página de avaliações">
        </mat-paginator>
      </div>
    </div>
  </div>
</div> 