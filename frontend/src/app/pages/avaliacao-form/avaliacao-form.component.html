<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="mt-3 text-muted">Carregando formulário de avaliação...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div *ngIf="errorMessage" class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="error-alert">
        <div class="error-icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="error-content">
          <h4>Erro ao carregar avaliação</h4>
          <p>{{ errorMessage }}</p>
          <button class="btn btn-primary" (click)="loadData()">
            <i class="bi bi-arrow-clockwise me-2"></i>
            Tentar Novamente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Evaluation Form -->
<div *ngIf="!isLoading && professor && avaliacaoForm" class="evaluation-page">
  <!-- Header Section -->
  <div class="evaluation-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="header-content">
            <h1 class="page-title">Avaliar Professor</h1>
            <div class="professor-info">
              <div class="professor-name">
                <i class="bi bi-person-circle me-2"></i>
                {{ professor.nomeCompleto }}
              </div>
              <div class="subject-info" *ngIf="cadeiraNome">
                <i class="bi bi-book me-2"></i>
                {{ cadeiraNome }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="btn btn-outline-secondary" (click)="cancelarAvaliacao()">
            <i class="bi bi-arrow-left me-2"></i>
            Voltar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <div class="form-container">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <form [formGroup]="avaliacaoForm" (ngSubmit)="onSubmit()">
            <!-- Period Section -->
            <div class="form-section">
              <div class="section-header">
                <h3 class="section-title">
                  <i class="bi bi-calendar-event me-2"></i>
                  Informações Gerais
                </h3>
              </div>
              <div class="section-content">
                <div class="row">
                  <div class="col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Período da Avaliação</mat-label>
                      <input matInput formControlName="periodo" placeholder="Ex: 2025.1" required>
                      <mat-icon matSuffix>schedule</mat-icon>
                      <mat-error *ngIf="avaliacaoForm.get('periodo')?.hasError('required')">
                        Período é obrigatório
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>
              </div>
            </div>

            <!-- Criteria Evaluation Section -->
            <div class="form-section" formArrayName="avaliacoesCriterios">
              <div class="section-header">
                <h3 class="section-title">
                  <i class="bi bi-clipboard-check me-2"></i>
                  Avaliação por Critério
                </h3>
                <p class="section-description">
                  Avalie cada critério de 1 a 5 estrelas e deixe seu comentário detalhado
                </p>
              </div>
              
              <div class="criteria-list">
                <div *ngFor="let criterioFormGroup of avaliacoesCriteriosArray.controls; let i = index" 
                     [formGroupName]="i" 
                     class="criteria-card">
                  <div class="criteria-header">
                    <h4 class="criteria-name">{{ criterioFormGroup.get('criterioNome')?.value }}</h4>
                    <div class="rating-preview">
                      <div class="stars-display">
                        <i class="bi bi-star-fill" 
                           *ngFor="let star of getStarsArray(criterioFormGroup.get('nota')?.value || 0)"
                           [ngClass]="{'filled': star <= (criterioFormGroup.get('nota')?.value || 0)}"></i>
                        <i class="bi bi-star" 
                           *ngFor="let star of getEmptyStarsArray(criterioFormGroup.get('nota')?.value || 0)"></i>
                      </div>
                      <span class="rating-text" *ngIf="criterioFormGroup.get('nota')?.value">
                        {{ criterioFormGroup.get('nota')?.value }}/5
                      </span>
                    </div>
                  </div>
                  
                  <div class="criteria-content">
                    <div class="row g-4">
                      <!-- Rating Section -->
                      <div class="col-lg-4">
                        <div class="rating-section">
                          <label class="form-label">Sua Avaliação</label>
                          <div class="interactive-rating">
                            <div class="rating-buttons">
                              <button type="button" 
                                      class="rating-btn"
                                      *ngFor="let rating of [1, 2, 3, 4, 5]"
                                      [ngClass]="{'active': rating <= (criterioFormGroup.get('nota')?.value || 0)}"
                                      (click)="setRating(i, rating)">
                                <i class="bi bi-star-fill"></i>
                                <span>{{ rating }}</span>
                              </button>
                            </div>
                            <div class="rating-labels">
                              <span class="label-start">Ruim</span>
                              <span class="label-end">Excelente</span>
                            </div>
                          </div>
                          <!-- Hidden input for form validation -->
                          <input type="hidden" formControlName="nota" required>
                          <div class="error-message" 
                               *ngIf="criterioFormGroup.get('nota')?.hasError('required') && criterioFormGroup.get('nota')?.touched">
                            Avaliação é obrigatória
                          </div>
                        </div>
                      </div>
                      
                      <!-- Comment Section -->
                      <div class="col-lg-8">
                        <div class="comment-section">
                          <label class="form-label">Comentário Detalhado</label>
                          <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Descreva sua experiência com este critério</mat-label>
                            <textarea matInput 
                                      formControlName="comentario"
                                      cdkTextareaAutosize 
                                      #autosize="cdkTextareaAutosize" 
                                      cdkAutosizeMinRows="3" 
                                      cdkAutosizeMaxRows="6"
                                      placeholder="Ex: O professor demonstra domínio excepcional do conteúdo, sempre esclarecendo dúvidas de forma clara..."></textarea>
                            <mat-icon matSuffix>comment</mat-icon>
                            <mat-hint>Seu comentário ajudará outros estudantes</mat-hint>
                          </mat-form-field>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- No Criteria Message -->
              <div *ngIf="avaliacoesCriteriosArray.length === 0 && !isLoading" class="empty-criteria">
                <div class="empty-icon">
                  <i class="bi bi-clipboard-x"></i>
                </div>
                <h4>Nenhum critério disponível</h4>
                <p>Não foi possível carregar os critérios de avaliação para este professor.</p>
              </div>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
              <div class="submit-card">
                <div class="submit-header">
                  <h3 class="submit-title">
                    <i class="bi bi-send me-2"></i>
                    Finalizar Avaliação
                  </h3>
                  <p class="submit-description">
                    Revise suas avaliações e clique em enviar para compartilhar sua experiência
                  </p>
                </div>
                <div class="submit-actions">
                  <button type="button" 
                          class="btn btn-outline-secondary btn-lg me-3" 
                          (click)="cancelarAvaliacao()">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancelar
                  </button>
                  <button type="submit" 
                          class="btn btn-primary btn-lg"
                          [disabled]="avaliacaoForm.invalid || isLoading">
                    <mat-spinner diameter="20" *ngIf="isLoading" class="me-2"></mat-spinner>
                    <i class="bi bi-check-circle me-2" *ngIf="!isLoading"></i>
                    {{ isLoading ? 'Enviando...' : 'Enviar Avaliação' }}
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div> 