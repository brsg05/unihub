<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="mt-3 text-muted">Carregando informações do professor...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div *ngIf="errorMessage" class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="error-card">
        <div class="error-icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h3>Oops! Algo deu errado</h3>
        <p>{{ errorMessage }}</p>
        <button class="btn btn-primary" (click)="errorMessage = null; isLoading = true">
          <i class="bi bi-arrow-clockwise me-2"></i>
          Tentar Novamente
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Professor Content -->
<div *ngIf="!isLoading && professor" class="professor-page">
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-3 text-center">
          <div class="professor-avatar">
            <img [src]="professor.photoUrl || 'assets/default-avatar.png'" 
                 [alt]="professor.nomeCompleto" 
                 class="avatar-image">
          </div>
        </div>
        <div class="col-md-9">
          <div class="professor-header">
            <h1 class="professor-name">{{ professor.nomeCompleto }}</h1>
            <div class="rating-section" *ngIf="professor.notaGeral">
              <div class="rating-display">
                <span class="rating-number">{{ professor.notaGeral | number:'1.1-1' }}</span>
                <div class="rating-stars">
                  <i class="bi" 
                     *ngFor="let filled of getStarsArray(professor.notaGeral)"
                     [ngClass]="filled ? 'bi-star-fill' : 'bi-star'"></i>
                </div>
              </div>
              <span class="rating-label">Avaliação Geral</span>
            </div>
            <div class="no-rating" *ngIf="!professor.notaGeral">
              <i class="bi bi-star me-2"></i>
              <span>Ainda não avaliado</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-4">
          <!-- Quick Stats Card -->
          <div class="stats-card">
            <h3 class="card-title">
              <i class="bi bi-graph-up me-2"></i>
              Estatísticas
            </h3>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bi bi-book"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ professor.cadeiras.length || 0 }}</span>
                  <span class="stat-label">Disciplinas</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bi bi-star"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ professor.notaGeral ? (professor.notaGeral | number:'1.1-1') : 'N/A' }}</span>
                  <span class="stat-label">Nota Geral</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Card -->
          <div class="action-card">
            <h3 class="card-title">
              <i class="bi bi-star-fill me-2"></i>
              Avaliação
            </h3>
            <p class="card-description">
              Compartilhe sua experiência e ajude outros estudantes a conhecerem melhor este professor.
            </p>
            <button class="btn btn-primary btn-evaluate" (click)="iniciarAvaliacao()">
              <i class="bi bi-star me-2"></i>
              Avaliar Professor
            </button>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-8">
          <!-- Disciplines Card -->
          <div class="content-card" *ngIf="professor.cadeiraNotas && professor.cadeiraNotas.length > 0">
            <div class="card-header">
              <h3 class="card-title">
                <i class="bi bi-journal-text me-2"></i>
                Disciplinas e Avaliações
              </h3>
              <p class="card-subtitle text-muted">
                Notas específicas por disciplina ministrada
              </p>
            </div>
            <div class="disciplines-with-ratings">
              <div class="discipline-rating-item" *ngFor="let cadeiraNote of professor.cadeiraNotas; trackBy: trackByCadeiraId">
                <div class="rating-header">
                  <div class="discipline-info">
                    <h5>{{ cadeiraNote.cadeiraNome }}</h5>
                    <div class="discipline-details">
                      <span class="course-name">{{ cadeiraNote.cursoNome }}</span>
                      <span class="badge badge-hours">{{ cadeiraNote.cargaHoraria }}h</span>
                      <span class="badge" 
                            [ngClass]="cadeiraNote.isEletiva ? 'badge-elective' : 'badge-mandatory'">
                        {{ cadeiraNote.isEletiva ? 'Eletiva' : 'Obrigatória' }}
                      </span>
                    </div>
                  </div>
                  <div class="rating-display">
                    <span class="rating-number-large">{{ cadeiraNote.notaMedia | number:'1.1-1' }}</span>
                    <div class="rating-stars-large">
                      <i class="bi" 
                         *ngFor="let filled of getStarsArray(cadeiraNote.notaMedia)"
                         [ngClass]="filled ? 'bi-star-fill' : 'bi-star'"></i>
                    </div>
                    <span class="evaluation-count">{{ cadeiraNote.totalAvaliacoes }} avaliações</span>
                  </div>
                </div>
                <div class="discipline-actions">
                  <button class="btn btn-outline-primary" (click)="avaliarProfessor(cadeiraNote.cadeiraId)">
                    <i class="bi bi-star me-1"></i>
                    Avaliar
                  </button>
                  <button class="btn btn-outline-success" (click)="verComentarios(cadeiraNote.cadeiraId)">
                    <i class="bi bi-chat-dots me-1"></i>
                    Ver Comentários
                  </button>
                  <button class="btn btn-outline-info" (click)="verEstatisticasCadeira(cadeiraNote.cadeiraId)">
                    <i class="bi bi-bar-chart me-1"></i>
                    Estatísticas
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Criteria Evaluation Card -->
          <div class="content-card" *ngIf="professor.criteriosComMedias && professor.criteriosComMedias.length > 0">
            <div class="card-header">
              <h3 class="card-title">
                <i class="bi bi-clipboard-check me-2"></i>
                Avaliação por Critério
              </h3>
            </div>
            <div class="criteria-list">
              <div class="criteria-item" *ngFor="let criterioMedia of professor.criteriosComMedias; trackBy: trackByCriterioId">
                <div class="criteria-main">
                  <div class="criteria-info">
                    <h5 class="criteria-name">{{ criterioMedia.criterio.nome }}</h5>
                    <div class="criteria-rating">
                      <span class="rating-badge" 
                            [ngClass]="{
                              'badge-excellent': criterioMedia.mediaNotas >= 4.5,
                              'badge-good': criterioMedia.mediaNotas >= 3.5 && criterioMedia.mediaNotas < 4.5,
                              'badge-average': criterioMedia.mediaNotas >= 2.5 && criterioMedia.mediaNotas < 3.5,
                              'badge-poor': criterioMedia.mediaNotas < 2.5
                            }">
                        {{ criterioMedia.mediaNotas | number:'1.1-1' }}
                      </span>
                      <div class="rating-stars-small">
                        <i class="bi" 
                           *ngFor="let filled of getStarsArray(criterioMedia.mediaNotas)"
                           [ngClass]="filled ? 'bi-star-fill' : 'bi-star'"></i>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Comentário Principal -->
                  <div class="criteria-comment" *ngIf="criterioMedia.topComentario">
                    <div class="comment-bubble">
                      <p class="comment-text">"{{ criterioMedia.topComentario.texto }}"</p>
                      <div class="comment-meta">
                        <span class="comment-author">Comentário destacado</span>
                        <span class="net-votes">{{ criterioMedia.topComentario.score }} pontos</span>
                        <div class="comment-actions">
                          <button class="btn btn-sm btn-outline-success" 
                                  (click)="voteComment(criterioMedia.topComentario.id, 'positive')"
                                  title="Votar positivamente">
                            <i class="bi bi-arrow-up"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger"
                                  (click)="voteComment(criterioMedia.topComentario.id, 'negative')"
                                  title="Votar negativamente">
                            <i class="bi bi-arrow-down"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-primary"
                                  (click)="verMaisComentarios(criterioMedia.criterio.id)">
                            <i class="bi bi-chat-dots me-1"></i>
                            {{ isCriterioExpanded(criterioMedia.criterio.id) ? 'Ver menos' : 'Ver mais comentários' }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Sem comentário -->
                  <div class="criteria-comment" *ngIf="!criterioMedia.topComentario">
                    <div class="no-comment">
                      <i class="bi bi-chat-dots me-2"></i>
                      <span>Seja o primeiro a comentar neste critério!</span>
                      <button class="btn btn-sm btn-outline-primary ms-2"
                              (click)="avaliarProfessor(0)">
                        <i class="bi bi-plus me-1"></i>
                        Avaliar
                      </button>
                    </div>
                  </div>

                  <!-- Seção expandida de comentários -->
                  <div class="expanded-comments" *ngIf="isCriterioExpanded(criterioMedia.criterio.id)">
                    <div class="expanded-header">
                      <h6>Comentários sobre {{ criterioMedia.criterio.nome }}</h6>
                      <small class="text-muted">
                        Esta funcionalidade será implementada em breve para mostrar todos os comentários deste critério.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- No Criteria Data -->
          <div class="content-card" *ngIf="!professor.criteriosComMedias || professor.criteriosComMedias.length === 0">
            <div class="empty-state">
              <div class="empty-icon">
                <i class="bi bi-clipboard-x"></i>
              </div>
              <h4>Ainda não há avaliações</h4>
              <p>Este professor ainda não foi avaliado por nenhum critério. Seja o primeiro a avaliar!</p>
              <button class="btn btn-primary" (click)="iniciarAvaliacao()">
                <i class="bi bi-star me-2"></i>
                Fazer Primeira Avaliação
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
