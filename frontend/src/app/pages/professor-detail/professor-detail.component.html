<div class="container mx-auto p-4">
  <div *ngIf="isLoading" class="flex justify-center items-center h-64">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
    <strong class="font-bold">Erro!</strong>
    <span class="block sm:inline">{{ errorMessage }}</span>
  </div>

  <div *ngIf="!isLoading && professor" class="professor-detail-card">
    <mat-card>
      <mat-card-header class="mb-4">
        <img mat-card-avatar [src]="professor.photoUrl || 'assets/default-avatar.png'" [alt]="professor.nomeCompleto" class="w-16 h-16 rounded-full mr-4">
        <mat-card-title class="text-3xl font-bold">{{ professor.nomeCompleto }}</mat-card-title>
        <mat-card-subtitle class="text-xl text-gray-600">Nota Geral: {{ professor.notaGeral | number:'1.1-2' }} ⭐</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <h3 class="text-2xl font-semibold mt-6 mb-3">Disciplinas Ministradas:</h3>
        <mat-list role="list">
          <mat-list-item *ngFor="let cadeira of professor.cadeiras" role="listitem">
            <mat-icon matListItemIcon>school</mat-icon>
            <div matListItemTitle>{{ cadeira.nome }}</div>
            <div matListItemLine>Carga Horária: {{ cadeira.cargaHoraria }}h - {{ cadeira.isEletiva ? 'Eletiva' : 'Obrigatória' }}</div>
          </mat-list-item>
        </mat-list>

        <mat-divider class="my-6"></mat-divider>

        <h3 class="text-2xl font-semibold mb-3">Avaliação por Critério:</h3>
        <div *ngIf="professor.criteriosComMedias && professor.criteriosComMedias.length > 0; else noCriteriaData">
          <table mat-table [dataSource]="professor.criteriosComMedias" class="mat-elevation-z2 w-full">
            <!-- Nome Critério Column -->
            <ng-container matColumnDef="nomeCriterio">
              <th mat-header-cell *matHeaderCellDef class="text-left py-3 px-4 font-semibold">Critério</th>
              <td mat-cell *matCellDef="let criterioMedia" class="py-3 px-4">
                <a [routerLink]="['/professores', professor.id, 'criterios', criterioMedia.criterio.id, 'avaliacoes']" 
                   class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer">
                  {{ criterioMedia.criterio.nome }}
                </a>
              </td>
            </ng-container>

            <!-- Média Column -->
            <ng-container matColumnDef="mediaNotas">
              <th mat-header-cell *matHeaderCellDef class="text-left py-3 px-4 font-semibold">Nota Média</th>
              <td mat-cell *matCellDef="let criterioMedia" class="py-3 px-4">{{ criterioMedia.mediaNotas | number:'1.1-2' }} ⭐</td>
            </ng-container>
            
            <!-- Top Comentário Column -->
            <ng-container matColumnDef="topComentario">
              <th mat-header-cell *matHeaderCellDef class="text-left py-3 px-4 font-semibold">Comentário em Destaque</th>
              <td mat-cell *matCellDef="let criterioMedia" class="py-3 px-4">
                <span *ngIf="criterioMedia.topComentario; else noComment">
                  "{{ criterioMedia.topComentario.texto }}"
                  <span class="text-xs text-gray-500 ml-2"> ({{ criterioMedia.topComentario.votosPositivos - criterioMedia.topComentario.votosNegativos }} votos)</span>
                </span>
                <ng-template #noComment>
                  <span class="italic text-gray-500">Nenhum comentário ainda.</span>
                </ng-template>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['nomeCriterio', 'mediaNotas', 'topComentario']"></tr>
            <tr mat-row *matRowDef="let criterioMedia; columns: ['nomeCriterio', 'mediaNotas', 'topComentario'];" 
                class="hover:bg-gray-50 transition-colors duration-150">
            </tr>
          </table>
        </div>
        <ng-template #noCriteriaData>
          <p class="italic text-gray-500">Ainda não há dados de critérios de avaliação para este professor.</p>
        </ng-template>

        <mat-divider class="my-6"></mat-divider>

        <!-- TODO: Implementar seção de comentários gerais ou link para página de avaliação -->
        <h3 class="text-2xl font-semibold mt-6 mb-3">Comentários Gerais (Em breve)</h3>

        <mat-divider class="my-6"></mat-divider>

        <div class="mt-6 flex justify-center">
          <button mat-raised-button color="primary" (click)="iniciarAvaliacao()">
            <mat-icon>rate_review</mat-icon>
            Avaliar Professor
          </button>
        </div>

      </mat-card-content>
    </mat-card>
  </div>
</div> 